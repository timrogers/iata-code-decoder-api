// Fastify Server Template
// Generated by Fastify Migration Skill

const fastify = require('fastify')({
  logger: {
    level: process.env.LOG_LEVEL || 'info',
    // Pretty print in development
    ...(process.env.NODE_ENV === 'development' && {
      transport: {
        target: 'pino-pretty',
        options: {
          translateTime: 'HH:MM:ss Z',
          ignore: 'pid,hostname',
        },
      },
    }),
  },
});

// ============================================================================
// Plugins
// ============================================================================

// CORS
fastify.register(require('@fastify/cors'), {
  origin: process.env.CORS_ORIGIN || true,
  credentials: true,
});

// Helmet for security headers
fastify.register(require('@fastify/helmet'), {
  contentSecurityPolicy: false, // Adjust based on needs
});

// Rate limiting
fastify.register(require('@fastify/rate-limit'), {
  max: 100,
  timeWindow: '15 minutes',
});

// Cookie support
fastify.register(require('@fastify/cookie'), {
  secret: process.env.COOKIE_SECRET || 'change-this-secret',
});

// Static files (if needed)
// fastify.register(require('@fastify/static'), {
//   root: path.join(__dirname, 'public')
// });

// ============================================================================
// Decorators
// ============================================================================

// Add custom decorators here
// fastify.decorate('db', database);
// fastify.decorateRequest('user', null);

// ============================================================================
// Hooks
// ============================================================================

// Request ID and timing
fastify.addHook('onRequest', async (request, reply) => {
  request.startTime = Date.now();
});

// Log request completion
fastify.addHook('onResponse', async (request, reply) => {
  const duration = Date.now() - request.startTime;
  request.log.info(
    {
      url: request.url,
      method: request.method,
      statusCode: reply.statusCode,
      duration,
    },
    'request completed',
  );
});

// ============================================================================
// Error Handler
// ============================================================================

fastify.setErrorHandler((error, request, reply) => {
  request.log.error(error);

  // Don't expose internal errors in production
  const statusCode = error.statusCode || 500;
  const message =
    process.env.NODE_ENV === 'production' && statusCode === 500
      ? 'Internal Server Error'
      : error.message;

  reply.status(statusCode).send({
    error: message,
    statusCode,
  });
});

// ============================================================================
// Routes
// ============================================================================

// Health check
fastify.get('/health', async (request, reply) => {
  return { status: 'ok', timestamp: Date.now() };
});

// Root route
fastify.get('/', async (request, reply) => {
  return { message: 'Fastify API Server' };
});

// Register route modules
// fastify.register(require('./routes/users'), { prefix: '/api/users' });
// fastify.register(require('./routes/posts'), { prefix: '/api/posts' });

// ============================================================================
// Server Start
// ============================================================================

const start = async () => {
  try {
    const port = process.env.PORT || 3000;
    const host = process.env.HOST || '0.0.0.0';

    await fastify.listen({ port, host });

    console.log(`ðŸš€ Fastify server running on http://${host}:${port}`);
    console.log(`ðŸ“Š Environment: ${process.env.NODE_ENV || 'development'}`);
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
};

// Handle graceful shutdown
const closeGracefully = async (signal) => {
  console.log(`\n${signal} received, closing server gracefully`);
  await fastify.close();
  process.exit(0);
};

process.on('SIGINT', () => closeGracefully('SIGINT'));
process.on('SIGTERM', () => closeGracefully('SIGTERM'));

// Start if run directly
if (require.main === module) {
  start();
}

module.exports = fastify;
